---
milestone: v1.0
audited: 2026-02-27T00:00:00Z
status: gaps_found
scores:
  requirements: 24/24
  phases: 3/3
  integration: 14/24
  flows: 2/4
gaps:
  integration:
    - id: INT-01
      description: "No HTTP controller for Phase 2 lifecycle operations"
      affected_requirements: [LCYC-01, LCYC-02, LCYC-05, LCYC-06, LCYC-07, LCYC-10, LCYC-11, LINE-01, LINE-02, LINE-03]
      severity: high
      evidence: "Grep of all @Post/@Get/@Put/@Patch/@Delete across src/ returns only Phase 3 endpoints + AppController GET /. createDraft, submit, placeInfoRequired, resubmit, recordReceipt, completeQc, resolve, close, addLine, updateLine, removeLine have zero HTTP bindings."
      resolution: "Build lifecycle.controller.ts (or equivalent) exposing the 12 missing Phase 2 service methods over HTTP with appropriate RBAC guards"
    - id: INT-02
      description: "completeQc() has no HTTP endpoint — RECEIVED → QC_COMPLETE transition unreachable over HTTP"
      affected_requirements: [LCYC-08]
      severity: medium
      evidence: "recordQcInspection() is exposed via POST /rmas/:id/lines/:lineId/qc-inspection (Phase 3). completeQc() (the status transition) has no controller binding."
      resolution: "Add POST /rmas/:id/complete-qc to the lifecycle controller"
    - id: INT-03
      description: "resolve() and close() have no HTTP endpoints — Finance gate WKFL-04 final step unreachable over HTTP"
      affected_requirements: [LCYC-09, LCYC-10, WKFL-04]
      severity: medium
      evidence: "GET /finance/credit-approvals and POST /rmas/:id/lines/:lineId/approve-credit are wired, but POST /rmas/:id/resolve and POST /rmas/:id/close are absent from all controllers."
      resolution: "Add resolve and close endpoints to the lifecycle controller"
  flows:
    - description: "Full RMA Lifecycle flow broken at HTTP layer — createDraft through close except approve/reject"
      affected_requirements: [LCYC-01, LCYC-02, LCYC-03, LCYC-04, LCYC-05, LCYC-06, LCYC-07, LCYC-08, LCYC-09, LCYC-10, LCYC-11]
      break_at: "HTTP layer — no lifecycle controller exists"
    - description: "Finance gate flow broken at final step — resolve() unreachable over HTTP"
      affected_requirements: [WKFL-04, LCYC-09]
      break_at: "POST /rmas/:id/resolve has no HTTP binding"
tech_debt:
  - phase: 01-foundation
    items:
      - "Docker Desktop not installed in execution environment — docker compose up never verified at runtime"
      - "prisma migrate dev never run — prisma/migrations/ directory does not exist; schema is correct and validated but no migration file generated"
      - "Integration tests (auth, audit, MERP) and e2e tests require Docker + migration before they can run — 3 unit tests pass, 11 tests pending Docker"
      - "Prisma 7 + Jest ESM/CJS interop issue documented in 01-04-SUMMARY.md — may require configuration fix before e2e tests pass"
      - "No @Public() decorator implemented — health check endpoint blocked by global JwtAuthGuard"
  - phase: 02-core-rma-lifecycle
    items:
      - "Integration tests (38 it() blocks) require Docker + DATABASE_URL before they can run — unit tests (41/41) confirmed green without DB"
  - phase: 03-workflow-and-line-operations
    items:
      - "Integration tests (16 tests) require Docker + DATABASE_URL + prisma migrate deploy before they can run"
      - "RBAC enforcement at HTTP layer requires live NestJS server to confirm — guard wiring is code-verified, runtime unverified"
      - "RmaRepository.updateLineQc() is dead code — service calls tx.rmaLine.update() directly after Phase 3 QC field extension"
      - "ValidationPipe global registration is a no-op — all validation is Zod-only; misleads future contributors"
      - "MerpAdapter never triggered by Phase 1-3 code — intentional deferral to Phase 4; document trigger point in Phase 4 plan"
  - phase: cross-phase
    items:
      - "RmaModule does not import UsersModule explicitly — branchScopeWhere dependency is satisfied transitively via AppModule → AuthModule → UsersModule; fragile if module graph changes"
      - "findById() in RmaRepository has no branch scope guard — structural data ownership on read is currently protected only by absence of a read endpoint, not by a query filter"
      - "WKFL-03 requirement description in REQUIREMENTS.md says uphold → Rejected; implementation routes CONTESTED → CLOSED per locked CONTEXT.md decision — REQUIREMENTS.md wording should be updated"
---

# Milestone Audit: RMS v1.0

**Milestone:** v1.0 — Returns Management System (Backend Core)
**Audited:** 2026-02-27
**Status:** gaps_found
**Phases in scope:** Phase 1 (Foundation), Phase 2 (Core RMA Lifecycle), Phase 3 (Workflow and Line Operations)

---

## Scores

| Dimension | Score | Notes |
|-----------|-------|-------|
| Requirements (code) | 24/24 | All 24 in-scope requirements implemented at service/test layer |
| Phase verifications | 3/3 | All phases have VERIFICATION.md; Phase 1 gaps_found (Docker only); Phases 2-3 passed |
| Integration (HTTP layer) | 14/24 | 10 requirements have no HTTP endpoint |
| E2E flows complete | 2/4 | Contest flow and Finance queue wired; Lifecycle flow and Finance gate resolve step broken |

---

## Phase Verification Summary

| Phase | Status | Score | Gaps |
|-------|--------|-------|------|
| Phase 1: Foundation | gaps_found | 5/7 | Docker not installed; migration never run. All FOUND requirements SATISFIED at code level. Infrastructure blockers only. |
| Phase 2: Core RMA Lifecycle | passed | 14/14 | None. All 14 truths verified. 41 unit tests GREEN. |
| Phase 3: Workflow and Line Operations | passed | 28/28 | None. All 28 truths verified. TypeScript build clean. |

---

## 3-Source Requirements Cross-Reference

### Source mapping
- **Source A**: Phase VERIFICATION.md requirements table (requirement-level verdict)
- **Source B**: Plan SUMMARY.md `requirements-completed` frontmatter
- **Source C**: REQUIREMENTS.md traceability table checkbox + status

| REQ-ID | Source A (VERIFICATION) | Source B (SUMMARY frontmatter) | Source C (REQUIREMENTS.md) | Final Status |
|--------|------------------------|-------------------------------|---------------------------|-------------|
| FOUND-01 | SATISFIED | listed (01-01-SUMMARY) | [x] Complete | **partial** — code satisfied; phase gaps_found due to Docker only |
| FOUND-02 | SATISFIED | listed (01-01-SUMMARY) | [x] Complete | **partial** — code satisfied; Phase 2 lifecycle has no HTTP surface for RBAC enforcement |
| FOUND-03 | SATISFIED (partial) | listed (01-01-SUMMARY) | [x] Complete | **partial** — branchScopeWhere implemented; findById() lacks read branch guard; no HTTP read endpoint currently |
| FOUND-04 | SATISFIED | listed (01-01-SUMMARY, 01-03-SUMMARY) | [x] Complete | **satisfied** — AuditService.logEvent(tx) signature enforces atomicity; 15+5 call sites in service |
| FOUND-05 | SATISFIED | listed (01-01-SUMMARY, 01-03-SUMMARY) | [x] Complete | **partial** — MerpAdapter scaffolded and DI-wired; never triggered by any Phase 1-3 code (by design; Phase 4 deferred) |
| LCYC-01 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; **no HTTP endpoint** |
| LCYC-02 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; **no HTTP endpoint** |
| LCYC-03 | SATISFIED | missing | [x] Complete | **partial** — service exposed via `POST /approvals/:id/approve` (WorkflowController) |
| LCYC-04 | SATISFIED | missing | [x] Complete | **partial** — service exposed via `POST /approvals/:id/reject` (WorkflowController) |
| LCYC-05 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; **no HTTP endpoint** |
| LCYC-06 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; **no HTTP endpoint** |
| LCYC-07 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; **no HTTP endpoint** |
| LCYC-08 | SATISFIED | missing | [x] Complete | **partial** — recordQcInspection HTTP-exposed (Phase 3); completeQc() (RECEIVED→QC_COMPLETE) **no HTTP endpoint** |
| LCYC-09 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; **no HTTP endpoint**; Finance gate enforced but unreachable over HTTP |
| LCYC-10 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; **no HTTP endpoint** |
| LCYC-11 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; **no HTTP endpoint** |
| LINE-01 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; **no HTTP endpoints** (addLine/updateLine/removeLine) |
| LINE-02 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; disposition lock enforced; **no HTTP endpoint** for line update |
| LINE-03 | SATISFIED | missing | [x] Complete | **partial** — service + integration test; integer qty guards correct; **no HTTP endpoint** |
| LINE-04 | SATISFIED | missing | [x] Complete | **satisfied** — splitLine() wired to `POST /rmas/:id/lines/:lineId/split` `@Roles('RETURNS_AGENT')` |
| WKFL-01 | SATISFIED | missing | [x] Complete | **satisfied** — findForApprovalQueue() → `GET /approvals/queue` `@Roles('BRANCH_MANAGER')` with branch scoping |
| WKFL-02 | SATISFIED | missing | [x] Complete | **satisfied** — contest() → `POST /rmas/:id/contest` `@Roles('CUSTOMER')` |
| WKFL-03 | SATISFIED | missing | [x] Complete | **satisfied** — overturn()+uphold() → `/overturn`+`/uphold` `@Roles('BRANCH_MANAGER')` |
| WKFL-04 | SATISFIED | missing | [x] Complete | **partial** — Finance queue + approveLineCredit endpoint wired; **resolve() has no HTTP endpoint** |
| WKFL-05 | SATISFIED | missing | [x] Complete | **satisfied** — recordQcInspection extended; `POST /rmas/:id/lines/:lineId/qc-inspection` `@Roles('QC')` |

**Orphan detection:** 0 orphans. All 24 in-scope requirements appear in all three sources.

**SUMMARY.md frontmatter note:** Phase 2 and Phase 3 plan summaries have empty `requirements-completed` arrays. This is a metadata completeness gap, not a code gap — all requirements are covered by the phase VERIFICATION.md evidence. The Phase 1 summaries (01-01, 01-03) correctly list their requirements.

---

## Integration Findings

### Critical: No HTTP Controller for Phase 2 Lifecycle Operations

The single most significant gap in the v1.0 milestone is that Phase 2's service methods — which implement the core RMA lifecycle (create, submit, cancel, info-required, resubmit, receipt, QC completion, resolve, close, line add/update/remove) — have **zero HTTP bindings** except for `approve()` and `reject()` which are exposed via WorkflowController.

This means the primary user story — "Returns Agent creates a new RMA, adds lines, and submits it" — cannot be completed over HTTP. The service layer and integration tests are correct and complete, but there is no controller to route HTTP requests to those methods.

**A lifecycle controller was never included in any Phase 1, 2, or 3 plan.** This was a scope omission in the planning stage, not a regression.

### E2E Flow Status

| Flow | Status | Break Point |
|------|--------|-------------|
| Full RMA lifecycle (Draft → Close) | BROKEN | No HTTP endpoints for createDraft, submit, cancel, infoRequired, resubmit, recordReceipt, completeQc, resolve, close |
| Contest flow (Rejected → CONTESTED → Approved/Closed) | COMPLETE | All endpoints wired (POST /contest, /overturn, /uphold) |
| Finance gate (QC_COMPLETE → Finance approves CREDIT → Resolve) | PARTIAL | Finance queue + approveLineCredit wired; resolve() has no endpoint |
| Auth chain (JWT → RmsAuthGuard → RolesGuard → endpoint) | COMPLETE | Wired across all Phase 3 controllers |

### Other Integration Findings

| Finding | Severity | Affected REQs |
|---------|----------|--------------|
| completeQc() has no HTTP endpoint | Medium | LCYC-08 |
| resolve() and close() have no HTTP endpoints | Medium | LCYC-09, LCYC-10, WKFL-04 |
| RmaRepository.updateLineQc() is dead code | Low | — |
| ValidationPipe global registration is a no-op (Zod handles all validation) | Low | — |
| findById() lacks branch-scope guard on read path | Low | FOUND-03 |
| No @Public() decorator — health check blocked by JwtAuthGuard | Low | — |
| MerpAdapter never triggered (intentional deferral) | Design note | FOUND-05 |
| RmaModule has undeclared transitive dependency on UsersModule | Low | — |

---

## Tech Debt Summary

**Phase 1 (5 items):** Docker/migration infrastructure; ESM/CJS test interop; no @Public() decorator

**Phase 2 (1 item):** Integration test suite requires Docker

**Phase 3 (5 items):** Integration tests require Docker; RBAC runtime verification pending; dead code (updateLineQc); ValidationPipe no-op; MerpAdapter trigger deferred

**Cross-phase (4 items):** UsersModule transitive dependency; findById() lacks read branch guard; REQUIREMENTS.md WKFL-03 wording mismatch; SUMMARY.md frontmatter incomplete for Phases 2-3

**Total: 15 tech debt items across 4 areas**

---

## Gaps to Close

### Gap 1 (HIGH): Lifecycle Controller — LCYC-01, 02, 05, 06, 07, 10, 11, LINE-01, 02, 03

A `lifecycle.controller.ts` (or equivalent) is needed to expose the Phase 2 service methods over HTTP:
- `POST /rmas` → createDraft (RETURNS_AGENT)
- `POST /rmas/:id/submit` → submit (RETURNS_AGENT, CUSTOMER)
- `POST /rmas/:id/cancel` → cancel (RETURNS_AGENT, ADMIN)
- `POST /rmas/:id/info-required` → placeInfoRequired (RETURNS_AGENT)
- `POST /rmas/:id/resubmit` → resubmit (CUSTOMER, RETURNS_AGENT)
- `POST /rmas/:id/receive` → recordReceipt (WAREHOUSE)
- `POST /rmas/:id/complete-qc` → completeQc (QC)
- `POST /rmas/:id/resolve` → resolve (RETURNS_AGENT, FINANCE)
- `POST /rmas/:id/close` → close (RETURNS_AGENT, ADMIN)
- `POST /rmas/:id/lines` → addLine (RETURNS_AGENT)
- `PATCH /rmas/:id/lines/:lineId` → updateLine (RETURNS_AGENT)
- `DELETE /rmas/:id/lines/:lineId` → removeLine (RETURNS_AGENT)
- `GET /rmas` → list (branch-scoped, multiple roles)
- `GET /rmas/:id` → get by ID (branch-scoped, multiple roles)

### Gap 2 (MEDIUM): completeQc HTTP endpoint — LCYC-08

`POST /rmas/:id/complete-qc` → completeQc (QC)

### Gap 3 (MEDIUM): resolve/close HTTP endpoints — LCYC-09, LCYC-10, WKFL-04

`POST /rmas/:id/resolve` (RETURNS_AGENT, FINANCE) and `POST /rmas/:id/close` (RETURNS_AGENT, ADMIN) — can be part of Gap 1 lifecycle controller.

---

## What Is Solid

Despite the integration gaps, the v1.0 foundation is strong:

- **Schema**: All models, enums, and fields are correct and generated. TypeScript build: 0 errors.
- **State machine**: ALLOWED_TRANSITIONS is the single authoritative source; assertValidTransition() called before every DB write; 41/41 unit tests green.
- **Service layer**: All 20 service methods (Phase 2 + Phase 3) are fully implemented with the fetch-validate-$transaction pattern and atomic audit writes.
- **Repository layer**: All 12 repository methods correct; $transaction never opened in repository (service owns the boundary).
- **Auth chain**: JwtStrategy → JwtAuthGuard (global APP_GUARD) → RmsAuthGuard → RolesGuard chain is complete and logically correct.
- **Phase 3 endpoints**: All 9 Phase 3 HTTP endpoints are wired with correct RBAC (contest, overturn, uphold, split, qc-inspection, approve-credit, approval queue, workflow approve/reject, finance credit queue).
- **Data integrity**: Finance approval gate, disposition lock, qty guards, one-contest rule, quantity conservation in splitLine — all enforced in service.
- **No anti-patterns**: Zero TODOs, FIXMEs, stubs, or empty implementations found in any source file.
- **Audit trail**: logEvent(tx) wired in all 20 service methods — atomicity enforced at the TypeScript type level.

---

## Recommendation

The gaps are plannable and self-contained. Run:

```
/gsd:plan-milestone-gaps
```

This will create gap-closure phases for:
1. A lifecycle controller exposing all Phase 2 service methods (primary gap)
2. completeQc/resolve/close endpoint additions (can be part of #1)

After gap closure, re-audit with `/gsd:audit-milestone` to confirm all 24 requirements are fully wired end-to-end.

---

_Audited: 2026-02-27_
_Auditor: Claude (gsd-integration-checker + orchestrator)_
