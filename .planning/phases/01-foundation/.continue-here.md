---
phase: 01-foundation
task: post-execution test fix
total_tasks: 4 plans complete, test tooling in progress
status: in_progress
last_updated: 2026-02-27T19:36:21.345Z
---

<current_state>
Phase 01 execution is complete (all 4 plans committed). Docker is running, migration applied, DB tables exist. Now fixing the e2e/integration test runner. Switched from Jest+--experimental-vm-modules to Vitest for integration tests, which resolved the ESM/CJS conflict. Two test files still failing:
- merp-stub.spec.ts: 4 failing — `this.prisma` is undefined in MerpStubAdapter during test
- auth.e2e.spec.ts: 5 skipped (beforeAll fails) — ConfigService not injected into JwtStrategy (`config` is undefined, `config.getOrThrow` throws)
- audit.integration.spec.ts: 2/2 PASSING ✓
- branch-scope.spec.ts (Jest unit): 3/3 PASSING ✓
</current_state>

<completed_work>

- Plan 01-01: NestJS scaffold, Docker Compose, Prisma 7 schema (5 tables + RmsRole enum), Zod env validation, PrismaModule — COMMITTED
- Plan 01-02: JWT guard chain (JwtAuthGuard, RmsAuthGuard, RolesGuard, @Roles decorator, UsersService, branchScopeWhere) — COMMITTED
- Plan 01-03: AuditService (tx-enforced), MerpAdapter abstract + MerpStubAdapter — COMMITTED
- Plan 01-04: Jest configs, test files written — COMMITTED
- Docker: `docker compose up -d` — postgres:16 + redis:7-alpine running and healthy
- Migration: `npx prisma migrate dev --name init-foundation` applied — all 5 tables + RmsRole enum in DB
- Switched test:e2e from Jest+vm-modules to Vitest (vitest.integration.config.ts created)
- Added `reflect-metadata` + `dotenv/config` to Vitest setupFiles
- audit.integration.spec.ts: 2/2 PASSING against real DB
</completed_work>

<remaining_work>

Fix 2 failing test suites:

**1. merp-stub.spec.ts** — `this.prisma` undefined in MerpStubAdapter
- Root cause: NestJS DI not injecting PrismaService into MerpStubAdapter in Vitest test context
- `MerpModule` doesn't declare `PrismaService` in its providers — relies on `@Global()` PrismaModule
- Try: Add `PrismaService` explicitly to MerpModule providers in test, OR check if `@Global()` works in NestJS testing module with Vitest
- The test imports `PrismaModule` but `@Global()` may not propagate to MerpModule's providers in TestingModule

**2. auth.e2e.spec.ts** — `config` (ConfigService) undefined in JwtStrategy constructor
- Root cause: Same NestJS DI issue — ConfigService not injected into JwtStrategy
- `JwtStrategy` constructor: `config: ConfigService` — ConfigService comes from `ConfigModule.forRoot({ isGlobal: true })`
- `AuthModule` provides `JwtStrategy` — AuthModule doesn't import ConfigModule directly (only inside JwtModule.registerAsync)
- Try: Explicitly import ConfigModule in AuthModule's imports array (not just inside JwtModule.registerAsync)
- OR: In the test, override JwtStrategy to not use ConfigService, or provide PORTAL_JWT_SECRET directly

**Both issues may share the same fix**: NestJS `@Global()` modules in TestingModule don't propagate as expected. The fix may be to explicitly import all required modules in each TestingModule setup.

**Other cleanup:**
- Remove/update `.planning/phases/01-foundation/01-VERIFICATION.md` (the 2 gaps it flagged are now resolved)
- Commit all uncommitted files: jest-e2e.config.ts (updated), vitest.integration.config.ts (new), package.json/lock (vitest added), VERIFICATION.md
</remaining_work>

<decisions_made>

- Switched e2e test runner from Jest to Vitest — Prisma 7 ESM client + NestJS CJS packages are mutually incompatible with Jest 30 + --experimental-vm-modules; Vitest handles both natively
- Created `generated/prisma/client-cjs-shim.ts` — not needed for Vitest (only needed for Jest CJS mode); can be deleted
- jest-e2e.config.ts is now dead code (test:e2e script uses vitest) — can leave for reference or delete
- Prisma 7 deviation: uses `PrismaPg` driver adapter + generated TypeScript client in `generated/prisma/` (not `@prisma/client` npm package)
- JWT is HS256 symmetric — needs portal team confirmation for production (may need RS256)
- MERP payload shapes are provisional — must validate with MERP team before v2
</decisions_made>

<blockers>

- **NestJS DI in Vitest TestingModule**: `@Global()` modules may not propagate properly. The audit integration tests work because they import PrismaModule directly AND use PrismaService directly (not through another module's DI chain). MerpStubAdapter and JwtStrategy both get their dependencies through multi-hop DI chains that may be breaking.
- **Specific suspicion**: NestJS TestingModule may require all transitive dependencies to be explicitly listed in the test's imports[] array, even if they're marked @Global() in production.
</blockers>

<context>
All the code is correct and the infrastructure works (audit tests pass against real DB). The remaining failures are NestJS DI wiring issues specific to the Vitest + TestingModule combination. The most likely fix is to explicitly provide all required modules/services in each TestingModule's imports array rather than relying on @Global() propagation.

For auth.e2e: Try adding `ConfigModule` directly to AuthModule's imports (not just inside JwtModule.registerAsync), or override JwtStrategy in test to provide the secret directly.

For merp-stub: Try adding `PrismaService` to MerpModule's providers, or explicitly import PrismaModule in MerpModule's imports array.

The audit tests work because PrismaService is imported directly via PrismaModule in the test — no multi-hop DI.
</context>

<next_action>
Start with: Fix merp-stub.spec.ts first (simpler). Add `PrismaModule` to MerpModule's `imports` array (it's currently missing — MerpModule relies entirely on @Global() for PrismaService). Then re-run `npm run test:e2e` to see if prisma is now injected.

Then fix auth.e2e: Verify AuthModule imports ConfigModule directly (not just inside JwtModule.registerAsync), so ConfigService is available to JwtStrategy.

Run: `cd rms-api && npm run test:e2e` to verify all tests pass.
After all green: commit all pending files and update VERIFICATION.md.
</next_action>
