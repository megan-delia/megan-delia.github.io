---
phase: 03.5-lifecycle-http-controller
plan: "01"
subsystem: api
tags: [nestjs, prisma, typescript, rma, branch-scoping, repository]

# Dependency graph
requires:
  - phase: 03-workflow-and-line-operations
    provides: RmaRepository base class with branchScopeWhere pattern, RmsUserContext, findForApprovalQueue

provides:
  - "findManyBranchScoped(user, options?) — paginated branch-filtered RMA list with lines"
  - "findByIdBranchScoped(id, user) — single RMA fetch returning null for both missing and out-of-scope records"

affects:
  - 03.5-02 (lifecycle controller plan — these methods are the data layer it calls)
  - 03.5-03 (integration tests — tests will call through controller to these methods)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "findFirst for id+scope compound queries — findUnique cannot compose additional WHERE conditions with branchScopeWhere"
    - "null-for-missing-or-out-of-scope — controller always maps null to 404, never 403, to avoid branch existence leaks"

key-files:
  created: []
  modified:
    - rms-api/src/rma/rma.repository.ts

key-decisions:
  - "findByIdBranchScoped uses findFirst not findUnique — branchScopeWhere adds non-unique conditions that Prisma cannot compose with findUnique"
  - "null return for missing and out-of-scope is intentional security boundary — controller maps to 404, not 403"
  - "findManyBranchScoped defaults take=50, orderBy createdAt desc — consistent with read endpoint conventions"

patterns-established:
  - "Branch-scoped list: spread branchScopeWhere(user) as first where clause, then additional filters"
  - "Branch-scoped single fetch: findFirst with id + spread branchScopeWhere(user) — never findUnique with scope"

requirements-completed: [LCYC-01, LCYC-02, LCYC-05, LCYC-06, LCYC-07, LCYC-08, LCYC-09, LCYC-10, LCYC-11, LINE-01, LINE-02, LINE-03]

# Metrics
duration: 4min
completed: 2026-02-28
---

# Phase 3.5 Plan 01: Branch-Scoped Repository Methods Summary

**Two Prisma repository methods closing the GET /rmas and GET /rmas/:id read-path gap — findManyBranchScoped and findByIdBranchScoped using branchScopeWhere for data ownership enforcement**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-28T17:33:39Z
- **Completed:** 2026-02-28T17:37:30Z
- **Tasks:** 2
- **Files modified:** 1

## Accomplishments

- Added `findManyBranchScoped` — paginated branch-filtered RMA list that spreads `branchScopeWhere(user)` into Prisma `findMany`, giving Admin users all records and all other roles only their branch records
- Added `findByIdBranchScoped` — single RMA fetch using `findFirst` (not `findUnique`) so the branch ownership filter composes cleanly with the id condition; returns null for both missing and cross-branch records
- Build verified clean with zero TypeScript errors after each task; original `findById` method unchanged

## Task Commits

Each task was committed atomically:

1. **Task 1: Add findManyBranchScoped to RmaRepository** - `1e5c6cf` (feat)
2. **Task 2: Add findByIdBranchScoped to RmaRepository** - `6981fcd` (feat)

## Files Created/Modified

- `rms-api/src/rma/rma.repository.ts` - Added two new branch-scoped read methods after `findCreditApprovalLines`; all 11 existing methods are unchanged

## Decisions Made

- `findByIdBranchScoped` uses `findFirst` not `findUnique` because Prisma's `findUnique` only accepts unique column conditions; `branchScopeWhere` adds a non-unique `branchId: { in: [...] }` condition that cannot compose with `findUnique`
- Returning `null` for both "does not exist" and "belongs to another branch" is an intentional security boundary — the controller maps null to `NotFoundException` (404), never `ForbiddenException` (403), preventing callers from probing whether records exist outside their branch
- `findManyBranchScoped` uses `take: 50` default and `orderBy: { createdAt: 'desc' }` to match the natural read-endpoint convention (newest first, reasonable page size)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Repository layer for lifecycle HTTP controller is complete — `findManyBranchScoped` and `findByIdBranchScoped` are ready to be called by `lifecycle.controller.ts` (Plan 02)
- No blockers; all imports were already in scope (branchScopeWhere, RmsUserContext, RmaStatus, RmaWithLines)

---
*Phase: 03.5-lifecycle-http-controller*
*Completed: 2026-02-28*
