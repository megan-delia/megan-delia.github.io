---
phase: 03.5-lifecycle-http-controller
plan: 02
subsystem: api
tags: [nestjs, zod, rbac, rma, lifecycle, http-controller]

# Dependency graph
requires:
  - phase: 03.5-lifecycle-http-controller/03.5-01
    provides: findManyBranchScoped and findByIdBranchScoped on RmaRepository
  - phase: 02-core-rma-lifecycle
    provides: RmaService with all lifecycle methods (createDraft, submit, cancel, etc.)
  - phase: 03-workflow-and-line-operations
    provides: RmaService line operations (addLine, updateLine, removeLine, recordReceipt, completeQc, resolve, close)
provides:
  - LifecycleController with 14 HTTP endpoints under @Controller('rmas')
  - GET /rmas and GET /rmas/:id with branch-scoped reads
  - POST /rmas → createDraft (RETURNS_AGENT)
  - POST /rmas/:id/submit → submit (RETURNS_AGENT, CUSTOMER)
  - POST /rmas/:id/cancel → cancel (RETURNS_AGENT, ADMIN)
  - POST /rmas/:id/info-required → placeInfoRequired (RETURNS_AGENT)
  - POST /rmas/:id/resubmit → resubmit (RETURNS_AGENT, CUSTOMER)
  - POST /rmas/:id/complete-qc → completeQc (QC)
  - POST /rmas/:id/resolve → resolve (RETURNS_AGENT, FINANCE)
  - POST /rmas/:id/close → close (RETURNS_AGENT, ADMIN)
  - POST /rmas/:id/lines/:lineId/receive → recordReceipt (WAREHOUSE)
  - POST /rmas/:id/lines → addLine (RETURNS_AGENT)
  - PATCH /rmas/:id/lines/:lineId → updateLine (RETURNS_AGENT)
  - DELETE /rmas/:id/lines/:lineId → removeLine (RETURNS_AGENT)
  - LifecycleController registered in RmaModule.controllers[]
affects: [03.5-03-e2e-tests, phase-04-finance-portal, phase-05-react-frontend]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Per-method @Roles() decorator (not class-level) — different roles per lifecycle endpoint
    - Zod .safeParse() with .flatten() error shape on all body-accepting endpoints
    - @Inject(Token) on all constructor params — esbuild/Vitest DI safety requirement
    - Thin controller — delegates entirely to service/repository; no business logic
    - Multiple controllers sharing @Controller('rmas') prefix — NestJS routes by method+path

key-files:
  created:
    - rms-api/src/rma/lifecycle.controller.ts
  modified:
    - rms-api/src/rma/rma.module.ts

key-decisions:
  - "Per-method @Roles() only — roles differ across endpoints (cannot use class-level like WorkflowController)"
  - "branchScopeWhere import omitted — not needed in controller layer; RmaRepository.findManyBranchScoped encapsulates it"
  - "LifecycleController injects both RmaService and RmaRepository — GET endpoints go direct to repository (no service indirection needed for reads)"

patterns-established:
  - "Thin HTTP controller pattern: Zod safeParse → BadRequestException on failure → delegate to service → return result"
  - "Branch-scoped read endpoints expose repository directly without service wrapper"

requirements-completed: [LCYC-01, LCYC-02, LCYC-05, LCYC-06, LCYC-07, LCYC-08, LCYC-09, LCYC-10, LCYC-11, LINE-01, LINE-02, LINE-03, WKFL-04]

# Metrics
duration: 2min
completed: 2026-02-28
---

# Phase 3.5 Plan 02: Lifecycle HTTP Controller Summary

**NestJS LifecycleController with 14 RBAC-guarded endpoints wiring all lifecycle service methods to HTTP under @Controller('rmas')**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-28T17:37:56Z
- **Completed:** 2026-02-28T17:40:23Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Created lifecycle.controller.ts with all 14 Phase 2 lifecycle HTTP endpoints — closes INT-01, INT-02, INT-03 from v1.0 milestone audit
- Correct per-method RBAC: RETURNS_AGENT creates/manages, WAREHOUSE receives, QC completes inspection, FINANCE resolves, ADMIN cancels/closes
- Registered LifecycleController in RmaModule.controllers[] — NestJS discovers all 14 endpoints at application startup
- `npm run build` exits 0 with no TypeScript errors after both tasks

## Task Commits

Each task was committed atomically:

1. **Task 1: Create lifecycle.controller.ts with all 14 endpoints** - `41185a9` (feat)
2. **Task 2: Wire LifecycleController into RmaModule** - `1c82dfb` (feat)

**Plan metadata:** TBD (docs: complete plan)

## Files Created/Modified
- `rms-api/src/rma/lifecycle.controller.ts` - NestJS controller with 14 endpoints: POST /rmas, GET /rmas, GET /rmas/:id, POST /:id/submit, cancel, info-required, resubmit, complete-qc, resolve, close, lines/:lineId/receive, POST/PATCH/DELETE /:id/lines[/:lineId]
- `rms-api/src/rma/rma.module.ts` - Added LifecycleController import and registered in controllers array

## Decisions Made
- Per-method `@Roles()` only — lifecycle endpoints span multiple different roles (RETURNS_AGENT, CUSTOMER, WAREHOUSE, QC, FINANCE, ADMIN) so class-level annotation is not viable
- `branchScopeWhere` import removed from controller — the repository methods `findManyBranchScoped` and `findByIdBranchScoped` already encapsulate branch filtering; importing it in the controller would be unused
- Controller injects both `RmaService` and `RmaRepository` with `@Inject()` — GET read endpoints go directly to repository since there is no business logic to enforce on reads (branch scope is the only gate, handled by repository)

## Deviations from Plan

None — plan executed exactly as written. The plan specified removing `branchScopeWhere` from the import if unused, which was applied proactively.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All 14 lifecycle endpoints are live and discoverable by NestJS
- Phase 3.5 Plan 03 (integration/e2e tests) can now exercise all endpoints over HTTP
- INT-01, INT-02, INT-03 gaps from v1.0 milestone audit are closed

---
*Phase: 03.5-lifecycle-http-controller*
*Completed: 2026-02-28*
